---
title: "Negative Net Worth SCF 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Set working directory
setwd("C:/Users/snabi/OneDrive - The Aspen Institute/Documents/Research/SCF_1989+2007+2019")

# Load libraries
library(tidyverse)
library(ggplot2)
library(spatstat)
library(survey)
library(magrittr)
library(expss)
library(weights)

# Read in data
scf_89_master <- read.csv("SCFP1989.csv")
scf_89 <- scf_89_master

scf_07_master <- read.csv("SCFP2007.csv")
scf_07 <- scf_07_master

scf_19_master <- read.csv("SCFP2019.csv")
scf_19 <- scf_19_master

# Disable scientific notation
options(scipen = 999)


# Functions # 

# Faster quantile function
weighted.quant <- function(var, weight, quantile) {
  weighted.quantile(var, weight, probs = seq(0, 1, quantile))
}


# Get weighted net worth quantile breaks
weighted_networth_quantiles <- function(var, weight, quantile) {
  df <- data.frame(weighted.quant(var, weight, quantile))
  return(c(df[,1]))
}


# Rename race categories
scf_19$RACE[scf_19$RACE == 1] <- "White, non-Hispanic"
scf_19$RACE[scf_19$RACE == 2] <- "Black, non-Hispanic"
scf_19$RACE[scf_19$RACE == 3] <- "Hispanic"
scf_19$RACE[scf_19$RACE == 5] <- "Other"


# Create new debt and asset categories
otherdebt <- scf_19 %>%
  select(OTHLOC, OTH_INST, ODEBT)
scf_19$OTHDBT <- rowSums(otherdebt)

securities <- select(scf_19, c(NMMF, SAVBND, STOCKS, BOND, WGT))
other_fin <- select(scf_19, c(CDS, CASHLI, OTHMA, OTHFIN, WGT))
nonres <- select(scf_19, c(ORESRE, NNRESRE, WGT))

scf_19$SECURITIES <- rowSums(securities[1:4])
scf_19$OTHFIN_COMPLETE <- rowSums(other_fin[1:4])
scf_19$NONRES <- rowSums(nonres[1:2])


# Create income quintiles 
inc_quintile_breaks_19 <- c(weighted_networth_quantiles(scf_19$INCOME, 
                                                  scf_19$WGT, 1/5))
inc_quintile_breaks_19[1] <- inc_quintile_breaks_19[1] - 1
scf_19$INCOME_quintiles <- cut(scf_19$INCOME,
                            c(inc_quintile_breaks_19),
                            labels = c("0-19.9", "20-39.9",
                                   "40-59.9", "60-79.9", 
                                   "80-100"))


# SCF net worth quintiles 
scf_19$nw_scf_breaks <- cut(scf_19$NETWORTH,
    c(-955502, 12410, 121760, 404100, 1218737, 1967199000),
    labels = c("Less than 25", "25-49.9",
                "50-74.9", "75-89.9", 
                "90-100"), na.rm = TRUE)

```


## Negative Net Worth Analysis


## Share of net debtors in overall population. 

```{r share net debtors of population}

# New variable that distinguishes net debt HHs from all HHs

scf_19 <- mutate(scf_19, 
                 netdebt_status = ifelse(scf_19$NETWORTH < 0, 1, 0))


# Taking weighted share of net debt households and all else

wpct(scf_19$netdebt_status, scf_19$WGT)


# New variable that distinguishes net debt HHs from all HHs

scf_07 <- mutate(scf_07, 
                 netdebt_status = ifelse(scf_07$NETWORTH < 0, 1, 0))


# Taking weighted share of net debt households and all else

wpct(scf_07$netdebt_status, scf_07$WGT)


# New variable that distinguishes net debt HHs from all HHs

scf_89 <- mutate(scf_89, 
                 netdebt_status = ifelse(scf_89$NETWORTH < 0, 1, 0))


# Taking weighted share of net debt households and all else

wpct(scf_89$netdebt_status, scf_89$WGT)

```


## Income quintile breakdowns


```{r Income and net worth}

# Creating a new subset of HHs with negative net worth

neg_nw <- filter(scf_19, scf_19$NETWORTH < 0)


# Comparing median income of households with and without net debt

weighted.median(neg_nw$INCOME, neg_nw$WGT)
weighted.median(scf_19$INCOME, scf_19$WGT)


# Get median debt, asset and net worth values for all HHs with net debt

neg_nw_wealth <- neg_nw %>%
  group_by(INCOME_quintiles) %>%
  summarise(median_debt = weighted.median(DEBT, WGT)/1000,
            median_assets = weighted.median(ASSET, WGT)/1000,
            median_nw = weighted.median(NETWORTH, WGT)/1000, 
            n = n())


# Get share of net debtors by income quintile

neg_nw_wealth$prop <- wpct(neg_nw$INCOME_quintiles, neg_nw$WGT)


# Export data

write.csv(neg_nw_count, paste(getwd(), 
                '\\neg_nw_count.csv', 
                sep=''))

```



## Net debtors by age group and race

```{r Net debtors by age group and race}


# Create three age categories

scf_19$age_group <- cut(scf_19$AGE,
                            c(17, 34, 54, 96),
                            labels = c("Under 35", "35-54",
                                   "Over 55"))


# Find share of net debtors by age group and race

prop_nd_race <- scf_19 %>%
  group_by(age_group, RACE) %>%
  summarise(prop = wpct(NETWORTH < 0, WGT)[1],
            prop_edu_all = wpct(EDN_INST > 0, WGT)[1],
            prop_edu = wpct(NETWORTH < 0 & EDN_INST > 0, WGT)[1],
            prop_veh = wpct(NETWORTH < 0 & VEH_INST > 0, WGT)[1],
            prop_ccbal = wpct(NETWORTH < 0 & CCBAL > 0, WGT)[1],
            prop_mort = wpct(NETWORTH < 0 & MRTHEL > 0, WGT)[1],
            prop_rdebt = wpct(NETWORTH < 0 & RESDBT > 0, WGT)[1],
            count = n())



neg_nw$age_group <- cut(neg_nw$AGE,
                            c(17, 34, 54, 96),
                            labels = c("Under 35", "35-54",
                                   "Over 55"))

prop2 <- neg_nw %>%
  group_by(age_group, RACE) %>%
    summarise(prop_edu = wpct(EDN_INST > 0, WGT)[1],
            count = n())
  

# age distribution

wpct(scf_19$age_group, scf_19$WGT)
wpct(neg_nw$age_group, neg_nw$WGT)

# Export to CSV 

write.csv(prop_nd_race, paste(getwd(), 
                '\\prop_nd_race.csv', 
                sep=''))

```



## Debt and Asset Shares Overall

```{r Debt and Asset Shares Overall}

# Total debt share 

all_debt <- select(neg_nw, MRTHEL, RESDBT, CCBAL, EDN_INST, VEH_INST, OTHDBT, WGT)

w_all_debt <- apply(all_debt, 2, function(x,w) {x*w}, w = all_debt$WGT)

totals <- apply(w_all_debt, 2, sum)
totals[4]/sum(totals)
```


## Asset and Debt Mixes

```{r Asset and debt mix for net debtors}

# Asset mix

# Isolating assets

assets_negnw_list <- select(neg_nw, LIQ, RETQLIQ, OTHFIN, SECURITIES, 
                     VEHIC, HOUSES, BUS, OTHNFIN, NONRES, WGT)


# Creating new weighted percentage function to use within apply function 

new_wpct <- function(x, w) {
  wpct(x > 0, w)
}


# Creating dataframe of median asset values and % holding them 

assets_negnw <- data.frame(med = apply(assets_negnw_list, 
                                       2, 
                                       weighted.median, 
                                       w = assets_negnw_list$WGT))

assets_negnw$prop <- t(data.frame(apply(assets_negnw_list, 
                                        2, 
                                        new_wpct, 
                                        w = assets_negnw$WGT))[1,])                         
assets_negnw <- assets_negnw[-c(10), ]                       
         
                           
# Export to csv

write.csv(assets_negnw,  paste(getwd(), 
                '\\assets_negnw.csv', 
                sep=''))



# Debt mix 

# Isolating debts

debt_negnw_list <- select(neg_nw, MRTHEL, RESDBT, CCBAL, EDN_INST, VEH_INST, OTHDBT, WGT)


# Creating dataframe of median debt values and % holding them

debt_negnw <- data.frame(med = apply(debt_negnw_list,
                                     2,
                                     weighted.median,
                                     w = debt_negnw_list$WGT))

debt_negnw$prop <- t(data.frame(apply(debt_negnw_list, 
                                        2, 
                                        new_wpct, 
                                        w = debt_negnw_list$WGT))[1,]) 

debt_negnw <- debt_negnw[-c(7), ] 


# checking sample sizes

sum(debt_negnw_list$MRTHEL > 0)
sum(debt_negnw_list$RESDBT > 0)
sum(debt_negnw_list$CCBAL > 0)
sum(debt_negnw_list$EDN_INST > 0)
sum(debt_negnw_list$VEH_INST > 0)
sum(debt_negnw_list$OTHDBT > 0)

                      
# Exporting to csv

write.csv(debt_negnw,  paste(getwd(), 
                '\\debt_negnw.csv', 
                sep=''))



```



## Debt mix among those holding 

```{r Debt mix among people holding debt}


# Calculating median debt value for select debt types among net debtors 
# holding them

debts_holding <- data.frame(RESDBT = weighted.median(filter(neg_nw,neg_nw$RESDBT > 0)$RESDBT, 
                filter(neg_nw,neg_nw$RESDBT > 0)$WGT),
                            MRTHEL = 
weighted.median(filter(neg_nw,neg_nw$MRTHEL > 0)$MRTHEL, 
                filter(neg_nw,neg_nw$MRTHEL > 0)$WGT),
                            CCBAL = 
weighted.median(filter(neg_nw,neg_nw$CCBAL > 0)$CCBAL, 
                filter(neg_nw,neg_nw$CCBAL > 0)$WGT),
                            EDN_INST = 
weighted.median(filter(neg_nw,neg_nw$EDN_INST > 0)$EDN_INST, 
                filter(neg_nw,neg_nw$EDN_INST > 0)$WGT),
                            VEH_INST = 
weighted.median(filter(neg_nw,neg_nw$VEH_INST > 0)$VEH_INST, 
                filter(neg_nw,neg_nw$VEH_INST > 0)$WGT),
                            OTHDBT = 
weighted.median(filter(neg_nw,neg_nw$OTHDBT > 0)$OTHDBT, 
                filter(neg_nw,neg_nw$OTHDBT > 0)$WGT))                              
write.csv(debts_holding,  paste(getwd(), 
                '\\debts_holding.csv', 
                sep=''))

nrow(filter(neg_nw, neg_nw$RESDBT > 0))
nrow(filter(neg_nw, neg_nw$MRTHEL > 0))
nrow(filter(neg_nw, neg_nw$CCBAL > 0))
nrow(filter(neg_nw, neg_nw$EDN_INST > 0))
nrow(filter(neg_nw, neg_nw$VEH_INST > 0))
nrow(filter(neg_nw, neg_nw$OTHDBT > 0))

```




## Racial distribution of net debtors

```{r racial breakdown}

# Data frame comparing racial breakdown of all HHs vs net debtors

race_scf_netdebtors <- data.frame(scf = wpct(scf_19$RACE, 
                                             scf_19$WGT),
                                  net_debtors = wpct(neg_nw$RACE,
                                                     neg_nw$WGT))


# Get sample sizes for each race in net debt 

count_nd <- neg_nw %>%
  group_by(RACE) %>%
  summarise(n = n())

# Exporting data 

write.csv(race_scf_netdebtors,  paste(getwd(), 
                '\\race_scf_netdebtors.csv', 
                sep=''))

```



## Measures of Debt Burden

## Income to Debt Ratio

```{r Income to debt ratio}

# Debt to income ratio compared to overall population

weighted.median(neg_nw$DEBT2INC, neg_nw$WGT)
weighted.median(scf_19$DEBT2INC, scf_19$WGT)


```

## Deliquent payments

```{r Late payments}


# Late payment in the last year 

nrow(filter(scf_19, scf_19$LATE == 1))
nrow(filter(neg_nw, neg_nw$LATE == 1))

wpct(scf_19$LATE, scf_19$WGT)
wpct(neg_nw$LATE, neg_nw$WGT)


# Payment past 60 days due 

nrow(filter(scf_19, scf_19$LATE60 == 1))
nrow(filter(neg_nw, neg_nw$LATE60 == 1))

wpct(scf_19$LATE60, scf_19$WGT)
wpct(neg_nw$LATE60, neg_nw$WGT)


```



## Age group comparison

```{r age group of net debtors}

weighted.median(scf_19$AGE, scf_19$WGT)
weighted.median(neg_nw$AGE, neg_nw$WGT)

wpct(neg_nw$age_group, neg_nw$WGT)

```

## Family structure and gender

```{r family structure and gender}

# Family structure



nrow(filter(scf_19, scf_19$FAMSTRUCT == 2))
nrow(filter(neg_nw, neg_nw$FAMSTRUCT == 2))

wpct(scf_19$FAMSTRUCT, scf_19$WGT)
wpct(neg_nw$FAMSTRUCT, neg_nw$WGT)



# Gender

nrow(filter(scf_19, scf_19$HHSEX == 2))
nrow(filter(neg_nw, neg_nw$HHSEX == 2))

wpct(scf_19$HHSEX, scf_19$WGT)
wpct(neg_nw$HHSEX, neg_nw$WGT)


# Gender breakdown of single parents

nrow(filter(filter(scf_19, scf_19$FAMSTRUCT == 1),
       filter(scf_19, scf_19$FAMSTRUCT == 1)$HHSEX == 2))

nrow(filter(filter(neg_nw, neg_nw$FAMSTRUCT == 1),
       filter(neg_nw, neg_nw$FAMSTRUCT == 1)$HHSEX == 2))


wpct(filter(scf_19, scf_19$FAMSTRUCT == 1)$HHSEX,
     filter(scf_19, scf_19$FAMSTRUCT == 1)$WGT)
wpct(filter(neg_nw, neg_nw$FAMSTRUCT == 1)$HHSEX,
     filter(neg_nw, neg_nw$FAMSTRUCT == 1)$WGT)


# Family structure breakdown of women-respondent HHs

wpct(filter(scf_19, scf_19$HHSEX == 2)$FAMSTRUCT,
     filter(scf_19, scf_19$HHSEX == 2)$WGT)
wpct(filter(neg_nw, neg_nw$HHSEX == 2)$FAMSTRUCT,
     filter(neg_nw, neg_nw$HHSEX == 2)$WGT)



```



## Housing status

```{r housing status}


wpct(scf_19$HOUSECL, scf_19$WGT)
wpct(neg_nw$HOUSECL, neg_nw$WGT)

```



## Education level

```{r Education}


# Education levels for all HHs
wpct(scf_19$EDCL, scf_19$WGT)

# Education levels for HHs with negative net worth
wpct(neg_nw$EDCL, neg_nw$WGT)

# Combining HS and no HS
sum(wpct(scf_19$EDCL, scf_19$WGT)[1], wpct(scf_19$EDCL, scf_19$WGT)[2])
sum(wpct(neg_nw$EDCL, neg_nw$WGT)[1], wpct(neg_nw$EDCL, neg_nw$WGT)[2])

# Breakdown of some college by race

wpct(filter(neg_nw, neg_nw$EDCL == 3)$RACE,
     filter(neg_nw, neg_nw$EDCL == 3)$WGT)

```






```{r work and occupation status}

wpct(scf_19$OCCAT1, scf_19$WGT)

wpct(neg_nw$OCCAT1, neg_nw$WGT)

wpct(scf_19$OCCAT2, scf_19$WGT)

wpct(neg_nw$OCCAT2, neg_nw$WGT)


# Labor force participation 

wpct(scf_19$LF, scf_19$WGT)

wpct(neg_nw$LF, neg_nw$WGT)

```


```{r burden of debt}

nrow(filter(scf_19, scf_19$TURNDOWN == 1))
nrow(filter(neg_nw, neg_nw$TURNDOWN == 1))

wpct(scf_19$TURNDOWN, scf_19$WGT)

wpct(neg_nw$TURNDOWN, neg_nw$WGT)


nrow(filter(scf_19, scf_19$BNKRUPLAST5 == 1))
nrow(filter(neg_nw, neg_nw$BNKRUPLAST5 == 1))

wpct(scf_19$BNKRUPLAST5, scf_19$WGT)

wpct(neg_nw$BNKRUPLAST5, neg_nw$WGT)


wpct(scf_19$FORECLLAST5, scf_19$WGT)

wpct(neg_nw$FORECLLAST5, neg_nw$WGT)


wpct(scf_19$NOCCBAL, scf_19$WGT)

wpct(neg_nw$NOCCBAL, neg_nw$WGT)


wpct(scf_19$EXPENSHILO, scf_19$WGT)

wpct(neg_nw$EXPENSHILO, neg_nw$WGT)


wpct(scf_19$SAVED, scf_19$WGT)

wpct(neg_nw$SAVED, neg_nw$WGT)


wpct(scf_19$WSAVED, scf_19$WGT)

wpct(neg_nw$WSAVED, neg_nw$WGT)


wpct(scf_19$HBORRALT, scf_19$WGT)

wpct(neg_nw$HBORRALT, neg_nw$WGT)

```


```{r other indicators of hardship}

wpct(scf_19$NOFINRISK, scf_19$WGT)

wpct(neg_nw$NOFINRISK, neg_nw$WGT)


wpct(scf_19$HCUTFOOD, scf_19$WGT)

wpct(neg_nw$HCUTFOOD, neg_nw$WGT)


```



```{r Payday loan}

wpct(scf_19$HPAYDAY, scf_19$WGT)

wpct(neg_nw$HPAYDAY, neg_nw$WGT)


scf_19$w_payday <- scf_19$HPAYDAY*scf_19$WGT

payday <- scf_19 %>%
  group_by(RACE) %>%
  summarise(wprop = sum(w_payday > 0)/n(),
            prop = sum(w_payday > 0)/n(),
            n = n())

payday_subset <- filter(scf_19, scf_19$HPAYDAY > 0)

wpct(payday_subset$RACE, payday_subset$WGT)

```


```{r young people net debtors?}

# Create age groups 

range(scf_19$AGE)

scf_19$age_group <- cut(scf_19$AGE,
                            c(17, 35, 45, 55, 65, 75, 96),
                            labels = c("Less than 35", "35-44",
                                   "45-54", "55-64", 
                                   "65-74", "75 or older"))


scf_19$w_nw <- scf_19$NETWORTH*scf_19$WGT


neg_nw$w_nw <- neg_nw$NETWORTH*neg_nw$WGT

neg_nw$age_group <- cut(neg_nw$AGE,
                            c(17, 35, 45, 55, 65, 75, 96),
                            labels = c("Less than 35", "35-44",
                                   "45-54", "55-64", 
                                   "65-74", "75 or older"))

netdebt_age <- neg_nw %>%
  group_by(age_group) %>%
  summarise(prop = n()/2540,
            n = n())



```


```{r student loanees net debtors}

wpct(filter(scf_19, scf_19$EDN_INST > 0)$NETWORTH < 0,
     filter(scf_19, scf_19$EDN_INST > 0)$WGT)


with_edu <- filter(scf_19, scf_19$EDN_INST > 0)



edu_stats <- with_edu %>%
  group_by(age_group) %>%
  summarise(prop = sum(w_nw < 0)/n(),
            med = weighted.median(EDN_INST, WGT))



```


```{r Estimate of family size}

weighted.mean(neg_nw$KIDS, neg_nw$WGT)

wpct(neg_nw$FAMSTRUCT, neg_nw$WGT)



```

